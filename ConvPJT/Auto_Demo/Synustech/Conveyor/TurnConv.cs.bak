using Microsoft.Office.Interop.Excel;
using Org.BouncyCastle.Crypto.Modes.Gcm;
using System;
using System.IO;
using System.Threading;
using WMX3ApiCLR;
using static Synustech.G_Var;

namespace Synustech
{
    internal class TurnConv : Conveyor
    {
        
        private enum TurnDirection
        {
            POS,
            NEG
        }
        private TurnDirection turn_direction = TurnDirection.NEG;
        private void StartTSV(TurnDirection turnDirection)
        {
            // 회전축을 지정된 속도로 조그 구동
            double speed = 50.0; // 원하는 속도 값 (예시)

            if (turnDirection == TurnDirection.NEG)
            {
                G_Var.bMouse = true;
                //w_motion.StartJogPos(Axis, 10);
                TurnJogNEG(speed);
            }
            else
            {
                //w_motion.StartJogPos(Axis, 10);
                TurnJogPOS(speed);
            }

        }
        private void StopTSV()
        {
            TurnJogSTOP();
        }
        public override void Init() 
        {
            InitComp = false;
            Thread InitThread = new Thread(() => 
            {
                Console.WriteLine(ID + ": Init Start");
                while (IsMainForm && (IsAutoRun || IsCycleRun) && !InitComp)
                {
                    switch (CV_InitStep)
                    {
                        case InitStep.Step000_Foup_Check:
                            {
                                CST_Check_Detect();
                                if (SCnVCSTBoth)
                                {
                                    CV_InitStep = InitStep.Step500_Init_Done;
                                }
                                else
                                {
                                    CV_InitStep = InitStep.Step100_Move;
                                }
                            }
                            break;

                        case InitStep.Step100_Move:
                            {
                                StartConveyor(Init_Velocity);

                                int elapsed = 0;
                                while(IsMainForm && (IsAutoRun || IsCycleRun) && !InitComp && elapsed < 5000)
                                {
                                    CST_Check_Detect();
                                    if (SCnVCSTBoth)
                                    {
                                        break;
                                    }
                                    Thread.Sleep(100);
                                    elapsed += 100;
                                }
                                StopConveyor();
                                CV_InitStep = InitStep.Step500_Init_Done;
                            }
                            break;

                        case InitStep.Step500_Init_Done:
                            {
                                InitComp = true;
                            }
                            break;

                        default:
                            {
                                CV_InitStep = InitStep.Step000_Foup_Check;
                            }
                            break;
                    }
                    Thread.Sleep(10);
                }
                Console.WriteLine(ID + " : Init Stop");
            });
            InitThread.Start();
        }
        public override void Turn_Init()
        {
            TCV_InitComp = false;
            Thread Turnthread = new Thread(() =>
            {
                Console.WriteLine(ID + ":" + "Turn Init Start");
                while (IsMainForm && (IsAutoRun || IsCycleRun) && !TCV_InitComp)
                {
                    switch (TCV_InitStep)
                    {
                        case TurnInitStep.Step000_POS_Check:
                            {
                                CoreMotionAxisStatus cmAxis = WMX3.m_coreMotionStatus.AxesStatus[TurnAxis];
                                Load_POS_Check();
                                Unload_POS_Check();
                                if ((TcvLoadDetect && cmAxis.ActualPos == LoadPos) || (TcvUnloadDetect && cmAxis.ActualPos == UnloadPos))
                                {
                                    TCV_InitStep = TurnInitStep.Step500_Turn_Init_Done;
                                }
                                else
                                {
                                    TCV_InitStep = TurnInitStep.Step100_Foup_Check;
                                }
                            }
                            break;

                        case TurnInitStep.Step100_Foup_Check:
                            {
                                CST_Empty_Detect();
                                CST_Check_Detect();
                                if (!SCnvCSTDetected || SCnVCSTBoth)
                                {
                                    TCV_InitStep = TurnInitStep.Step200_Turn_Move;
                                }
                                else if (SCnvFoupDetect[0] == SensorOnOff.Off && SCnvFoupDetect[1] == SensorOnOff.On)
                                {
                                    StartConveyor(Init_Velocity);
                                    TCV_InitStep = TurnInitStep.Step110_Foup_Both_Check;
                                }
                                else if (SCnvFoupDetect[0] == SensorOnOff.On && SCnvFoupDetect[1] == SensorOnOff.Off)
                                {
                                    portDirection = LineDirection.Output;
                                    StartConveyor(Init_Velocity);
                                    portDirection = LineDirection.Input;
                                    TCV_InitStep = TurnInitStep.Step110_Foup_Both_Check;
                                }
                            }
                            break;

                        case TurnInitStep.Step110_Foup_Both_Check:
                            {
                                CST_Check_Detect();
                                if (SCnVCSTBoth)
                                {
                                    StopConveyor();
                                    TCV_InitStep = TurnInitStep.Step200_Turn_Move;
                                }
                            }
                            break;

                        case TurnInitStep.Step200_Turn_Move:
                            {
                                Absolute_Turn_Move_Load();
                                TCV_InitStep = TurnInitStep.Step210_Turn_Stop_Check;
                            }
                            break;

                        case TurnInitStep.Step210_Turn_Stop_Check:
                            {
                                CoreMotionAxisStatus cmAxis = WMX3.m_coreMotionStatus.AxesStatus[TurnAxis];
                                Load_POS_Check();
                                if (TcvLoadDetect && cmAxis.ActualPos == LoadPos)
                                {
                                    TCV_InitStep = TurnInitStep.Step500_Turn_Init_Done;
                                }
                            }
                            break;

                        case TurnInitStep.Step500_Turn_Init_Done:
                            {
                                TCV_InitComp = true;
                            }
                            break;

                        default:
                            {
                                CV_InitStep = InitStep.Step000_Foup_Check;
                            }
                            break;
                    }
                    Thread.Sleep(10);
                }
                Console.WriteLine(ID + " : Turn Init Stop");
            });
            Turnthread.Start();
        }
        /// <summary>
        /// Auto 공정 함수
        /// </summary>
        public override void Auto_Start_CV_Control()
        {
            mode = Mode.Auto;
            InmodeConvCheck();
            portDirection = LineDirection.Input;
            CV_AutoStep = AutoStep.Step000_Check_Direction;
            bool modechange = IsInput;
            Thread LocalThread = new Thread(() =>
            {
                Console.WriteLine(ID + ":" + "Auto Start");
                while (IsMainForm && (G_Var.IsAutoRun || G_Var.IsCycleRun) && (NCV_AutoRunning || NCV_CycleRunning))
                {
                    if (modechange != IsInput)
                    {
                        if (IsInput)
                        {
                            portDirection = LineDirection.Input;
                        }
                        else
                        {
                            {
                                portDirection = LineDirection.Output;
                            }
                        }
                        CV_AutoStep = AutoStep.Step000_Check_Direction;
                        modechange = IsInput;
                    }
                    switch (CV_AutoStep)
                    {
                        /// <summary>
                        /// 1. 운영 방향과 운전 방향 확인
                        /// </summary>
                        case AutoStep.Step000_Check_Direction:
                            {
                                if (GetOperationDirection() == LineDirection.Input)
                                {
                                    CV_AutoStep = AutoStep.Step100_InMode_Check_CST_Load_Status;
                                }

                                else
                                {
                                    CV_AutoStep = AutoStep.Step300_OutMode_Check_CST_Load_Status;
                                }
                            }
                            break;

                        /// <summary>
                        /// 1.현재 자재가 있는지 확인 (자재가 있으면 CSTDetected = true)
                        /// 2.현재 스텝을 IDLE로 판단.
                        /// </summary>
                        case AutoStep.Step100_InMode_Check_CST_Load_Status:
                            {
                                // Load 상태
                                turnstatus = TurnStatus.Load;
                                Load_POS_Check();
                                CST_Empty_Detect();
                                // Load 위치에 있지 않는 경우
                                if (!TcvLoadDetect)
                                {
                                    CV_AutoStep = AutoStep.Step710_InMode_Move_T_0_Deg;
                                }
                                // Load 위치에 위치해 있고 Foup이 감지 되는 경우
                                else if (TcvLoadDetect && SCnvCSTDetected)
                                {
                                    Thread.Sleep(2000);
                                    CV_AutoStep = AutoStep.Step210_InMode_Move_CV_Rolling_In;
                                }
                                // Load 위치에 위치해 있지만 Foup이 감지 되지 않는 경우
                                else if (beforeconv != null && TcvLoadDetect && !SCnvCSTDetected)
                                {
                                    Thread.Sleep(100);
                                    CV_AutoStep = AutoStep.Step500_InMode_Get_CST_Rolling;
                                }
                            }
                            break;

                        /// <summary>
                        /// 1. 자재 ID를 읽을 준비를 하는 스텝, 추후 추가시 주석해제 수정 필요.
                        /// </summary>
                        //case NORMAL_CV_AutoStep.Step200_InMode_Start_CST_Pass_From_CV:
                        //    {
                        //        // 이전 컨베이어에서 자재를 받을 수 있는 상태 확인
                        //        if (Carrier_CheckLP_ExistProduct(true))
                        //        {
                        //            // 자재 ID 읽기 준비
                        //            CV_AutoStep = NORMAL_CV_AutoStep.Step210_InMode_Move_CV_Rolling;
                        //        }
                        //        else
                        //        {
                        //            
                        //        }
                        //    }
                        //    break;


                        /// <summary>
                        /// 1. 컨베어구동 동작 진행
                        /// </summary>
                        case AutoStep.Step210_InMode_Move_CV_Rolling_In:
                            {
                                // Busy 상태
                                turnstatus = TurnStatus.Busy;
                                // 컨베이어 구동
                                StartConveyor(AutoVelocity);
                                if(beforeconv != null)
                                {   
                                    // 이전 컨베이어 타입에 따라 분류
                                    if (beforeconv.type == "Long")
                                    {
                                        beforeconv.LCnV_CST_Empty_Detect();
                                        // 이전 컨베이어의 Foup 감지 센서가 모두 Off면 동작
                                        if (!beforeconv.LCnvCSTDetected)
                                        {
                                            CV_AutoStep = AutoStep.Step215_InMode_Move_CV_Slow;
                                        }
                                    }
                                    else
                                    {
                                        beforeconv.CST_Empty_Detect();
                                        // 이전 컨베이어의 Foup 감지 센서가 모두 Off면 동작
                                        if (!beforeconv.SCnvCSTDetected)
                                        {
                                            CV_AutoStep = AutoStep.Step215_InMode_Move_CV_Slow;
                                        }
                                    }
                                }
                                // 이전 컨베이어가 없는 경우 (시작 컨베이어)
                                else
                                {
                                    CV_AutoStep = AutoStep.Step220_InMode_Run_Condition_Check;
                                }


                                //NcvSeqLog(CV_AutoStep, enLogType.Process, enLogLevel.Normal, enLogTitle.TcvAutoStep, $"{ID} Auto ");
                                //Thread.Sleep(500);
                            }
                            break;

                        /// <summary>
                        /// 1. 앞 Conv에 Foup 존재 시 속도 줄임
                        /// </summary
                        case AutoStep.Step215_InMode_Move_CV_Slow:
                            {
                                if (nextconv != null && beforeconv != null)
                                {
                                    // Load위치와 Unload위치가 다를 때
                                    if (LoadPos != UnloadPos)
                                    {
                                        // 이전 컨베이어의 타입에 따라 분류
                                        if (beforeconv.type == "Long")
                                        {
                                            beforeconv.LCnV_CST_Empty_Detect();
                                            // 이전 컨베이어에서 Foup이 감지 되지 않는 경우 저속
                                            if (!beforeconv.LCnvCSTDetected)
                                            {
                                                StartConveyor(SlowVelocity);

                                            }
                                        }
                                        else
                                        {
                                            beforeconv.CST_Empty_Detect();
                                            // 이전 컨베이어에서 Foup이 감지 되지 않는 경우 저속
                                            if (!beforeconv.SCnvCSTDetected)
                                            {
                                                StartConveyor(SlowVelocity);
                                            }
                                        }
                                    }
                                    // Load 위치와 Unload 위치가 같은 경우
                                    else if (LoadPos == UnloadPos)
                                    {
                                        // 이전 컨베이어의 타입에 따라 분류
                                        if (beforeconv.type == "Long")
                                        {
                                            beforeconv.LCnV_CST_Empty_Detect();
                                            // 이전 컨베이어에서 Foup이 감지 되지 않는 경우
                                            if (!beforeconv.LCnvCSTDetected)
                                            {
                                                // 다음 컨베이어의 타입에 따라 분류
                                                if (nextconv.type == "Long")
                                                {
                                                    nextconv.LCnV_CST_Empty_Detect();
                                                    // 다음 컨베이어에 Foup이 있다면 저속
                                                    if (nextconv.LCnvCSTDetected)
                                                    {
                                                        StartConveyor(SlowVelocity);
                                                    }
                                                }
                                                else
                                                {
                                                    nextconv.CST_Empty_Detect();
                                                    // 다음 컨베이어에 Foup이 있다면 저속
                                                    if (nextconv.SCnvCSTDetected)
                                                    {
                                                        StartConveyor(SlowVelocity);
                                                    }
                                                }
                                            }
                                        }
                                        else
                                        {
                                            beforeconv.CST_Empty_Detect();
                                            // 이전 컨베이어에서 Foup이 감지 되지 않는 경우
                                            if (!beforeconv.SCnvCSTDetected)
                                            {
                                                // 다음 컨베이어의 타입에 따라 분류
                                                if (nextconv.type == "Long")
                                                {
                                                    nextconv.LCnV_CST_Empty_Detect();
                                                    // 다음 컨베이어에 Foup이 있다면 저속
                                                    if (nextconv.LCnvCSTDetected)
                                                    {
                                                        StartConveyor(SlowVelocity);
                                                    }
                                                }
                                                else
                                                {
                                                    nextconv.CST_Empty_Detect();
                                                    // 다음 컨베이어에 Foup이 있다면 저속
                                                    if (nextconv.SCnvCSTDetected)
                                                    {
                                                        StartConveyor(SlowVelocity);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    CV_AutoStep = AutoStep.Step220_InMode_Run_Condition_Check;
                                }
                                // 다음 컨베이어가 없는 경우 (마지막 컨베이어)
                                else if (nextconv == null)
                                {
                                    StartConveyor(SlowVelocity);
                                    CV_AutoStep = AutoStep.Step220_InMode_Run_Condition_Check;
                                }
                                // 이전 컨베이어가 없는 경우 (시작 컨베이어)
                                else if (beforeconv == null)
                                {
                                    StartConveyor(SlowVelocity);
                                    CV_AutoStep = AutoStep.Step220_InMode_Run_Condition_Check;
                                }
                            }
                            break;
                        /// <summary>
                        /// 1. Foup Detect#1,#2 모두 감지 되면 정지
                        /// </summary>
                        case AutoStep.Step220_InMode_Run_Condition_Check:
                            {
                                CST_Check_Detect();
                                // Load위치와 Unload위치가 같고 Foup이 정위치에 있을 때
                                if ((LoadLocation == UnloadLocation) && SCnVCSTBoth)
                                {
                                    if (nextconv != null)
                                    {
                                        // 다음 컨베이어의 타입에 따라 분류
                                        if (nextconv.type == "Normal")
                                        {
                                            nextconv.CST_Empty_Detect();
                                            // 다음 컨베이어가 비어 있는 경우
                                            if (!nextconv.SCnvCSTDetected)
                                            {
                                                CV_AutoStep = AutoStep.Step260_InMode_Unload_Turn_Stop;
                                            }
                                            // 다음 컨베이어에 Foup이 적재되어 있는 경우 정지
                                            else
                                            {
                                                StopConveyor();
                                                CV_AutoStep = AutoStep.Step250_InMode_Move_CV_Rolling_Out;
                                            }
                                        }
                                        // 다음 컨베이어가 Long 컨베이어인 경우
                                        else if (nextconv.type == "Long")
                                        {
                                            nextconv.LCnV_CST_Empty_Detect();
                                            // 다음 컨베이어가 비어 있는 경우
                                            if (!nextconv.LCnvCSTDetected)
                                            {
                                                CV_AutoStep = AutoStep.Step260_InMode_Unload_Turn_Stop;
                                            }
                                            // 다음 컨베이어에 Foup이 적재되어 있는 경우 정지
                                            else
                                            {
                                                StopConveyor();
                                                CV_AutoStep = AutoStep.Step250_InMode_Move_CV_Rolling_Out;
                                            }
                                        }
                                    }
                                    // 마지막 컨베이어인 경우 정지
                                    else
                                    {
                                        StopConveyor();
                                        CV_AutoStep = AutoStep.Step900_Final_CV_Wait;
                                    }
                                }
                                // Load 위치와 Unload 위치가 다른 경우 정지
                                else if (SCnVCSTBoth)
                                {
                                    StopConveyor();

                                    CV_AutoStep = AutoStep.Step730_InMode_Unload_Move;
                                }
                            }
                            break;

                        /// <summary>
                        /// 1.다음 컨베이어가 Load 할 수 있는 조건인지 확인
                        /// </summary>
                        case AutoStep.Step250_InMode_Move_CV_Rolling_Out:
                            {
                                // 다음 컨베이어의 타입에 따라 분류
                                if (nextconv.type == "Normal")
                                {
                                    nextconv.CST_Empty_Detect();
                                    // 다음 컨베이어가 비어 있는 경우
                                    if (!nextconv.SCnvCSTDetected)
                                    {
                                        // Unload 상태
                                        turnstatus = TurnStatus.Unload;
                                        // Load위치와 Unload위치가 다르고 POS Sensor의 차이가 2가 날 때
                                        //Ex) Load : Pos[0] / Unload : Pos[2]
                                        if(LoadLocation != UnloadLocation && ((UnloadLocation - LoadLocation) % 2 == 0))
                                        {
                                            Thread.Sleep(500);
                                            // 방향을 Neg로 변경 후 이동
                                            portDirection = LineDirection.Output;
                                            StartConveyor(AutoVelocity);
                                            // 즉시 방향 Input으로 변경
                                            portDirection = LineDirection.Input;
                                        }
                                        else
                                        {
                                            Thread.Sleep(500);
                                            StartConveyor(AutoVelocity);
                                        }
                                        CV_AutoStep = AutoStep.Step260_InMode_Unload_Turn_Stop;
                                    }
                                }
                                else if (nextconv.type == "Long")
                                {
                                    nextconv.LCnV_CST_Empty_Detect();
                                    // 다음 컨베이어가 비어 있는 경우
                                    if (!nextconv.LCnvCSTDetected)
                                    {
                                        // Unload 상태
                                        turnstatus = TurnStatus.Unload;
                                        // Load위치와 Unload위치가 다르고 POS Sensor의 차이가 2가 날 때
                                        //Ex) Load : Pos[0] / Unload : Pos[2]
                                        if (LoadLocation != UnloadLocation && ((UnloadLocation - LoadLocation) % 2 == 0))
                                        {
                                            Thread.Sleep(500);
                                            // 방향을 Neg로 변경 후 이동
                                            portDirection = LineDirection.Output;
                                            StartConveyor(AutoVelocity);
                                            // 즉시 방향 Input으로 변경
                                            portDirection = LineDirection.Input;
                                        }
                                        else
                                        {
                                            Thread.Sleep(500);
                                            StartConveyor(AutoVelocity);
                                        }
                                        CV_AutoStep = AutoStep.Step260_InMode_Unload_Turn_Stop;
                                    }
                                }
                            }
                            break;

                        /// <summary>
                        /// 1.다음 컨베이어로 Foup을 Unload한 경우 정지
                        /// </summary>
                        case AutoStep.Step260_InMode_Unload_Turn_Stop:
                            {
                                turnstatus = TurnStatus.Unload;
                                CST_Empty_Detect();
                                // Foup이 다 빠져 나간 경우
                                if (!SCnvCSTDetected)
                                {
                                    // 0.3초 후 정지
                                    Thread.Sleep(300);
                                    StopConveyor();
                                    // Load 위치와 Unload 위치가 같은 경우 초기화
                                    if (LoadLocation == UnloadLocation)
                                    {
                                        CV_AutoStep = AutoStep.Step000_Check_Direction;
                                    }
                                    // Load 위치와 Unload 위치가 다른 경우
                                    else
                                    {
                                        // 다음 컨베이어의 타입에 따라 분류
                                        if(nextconv.type == "Long")
                                        {
                                            nextconv.LCnV_CST_Empty_Detect();
                                            // 다음 컨베이어에 Foup이 감지된 경우
                                            if (nextconv.LCnvCSTDetected)
                                            {
                                                CV_AutoStep = AutoStep.Step750_InMode_Return_T_Move;
                                            }
                                        }
                                        else
                                        {
                                            nextconv.CST_Empty_Detect();
                                            // 다음 컨베이어에 Foup이 감지된 경우
                                            if (nextconv.SCnvCSTDetected)
                                            {
                                                CV_AutoStep = AutoStep.Step750_InMode_Return_T_Move;
                                            }
                                        }
                                    }
                                }
                            }
                            break;

                        /// <summary>
                        /// 1. 물체가 감지되면 Step210으로 변경
                        /// </summary>
                        case AutoStep.Step275_InMode_Change_210:
                            {
                                CST_Empty_Detect();
                                // Foup이 감지된 경우
                                if (SCnvCSTDetected)
                                {
                                    CV_AutoStep = AutoStep.Step210_InMode_Move_CV_Rolling_In;
                                }
                            }
                            break;

                        case AutoStep.Step300_OutMode_Check_CST_Load_Status:
                            {
                                // Unload 상태
                                turnstatus = TurnStatus.Load;
                                Unload_POS_Check();
                                CST_Empty_Detect();
                                // Unload 위치에 있지 않는 경우
                                if (!TcvUnloadDetect)
                                {
                                    CV_AutoStep = AutoStep.Step810_OutMode_Move_T_Unload;
                                }
                                // Unload 위치에 위치해 있고 Foup이 감지 되는 경우
                                else if(TcvUnloadDetect && SCnvCSTDetected)
                                {
                                    Thread.Sleep(2000);
                                    CV_AutoStep = AutoStep.Step410_OutMode_Move_CV_Rolling_out;
                                }
                                // Unload 위치에 위치해 있지만 Foup이 감지 되지 않는 경우
                                else if(nextconv != null && TcvUnloadDetect && !SCnvCSTDetected)
                                {
                                    Thread.Sleep(100);
                                    CV_AutoStep = AutoStep.Step600_OutMode_Get_CST_Rolling;
                                }
                            }
                            break;

                        case AutoStep.Step410_OutMode_Move_CV_Rolling_out:
                            {
                                // Busy 상태
                                turnstatus = TurnStatus.Busy;
                                // 컨베이어 구동
                                if (LoadLocation != UnloadLocation && ((UnloadLocation - LoadLocation) % 2 == 0))
                                {
                                    portDirection = LineDirection.Input;
                                }
                                StartConveyor(AutoVelocity);
                                portDirection = LineDirection.Output;
                                if (nextconv != null)
                                {
                                    // 이전 컨베이어 타입에 따라 분류
                                    if(nextconv.type == "Long")
                                    {
                                        nextconv.LCnV_CST_Empty_Detect();
                                        // 이전 컨베이어의 Foup 감지 센서가 모두 Off면 동작
                                        if (!nextconv.LCnvCSTDetected)
                                        {
                                            CV_AutoStep = AutoStep.Step415_OutMode_Move_CV_Slow;
                                        }
                                    }
                                    else
                                    {
                                        nextconv.CST_Empty_Detect();
                                        // 이전 컨베이어의 Foup 감지 센서가 모두 Off면 동작
                                        if (!nextconv.SCnvCSTDetected)
                                        {
                                            CV_AutoStep = AutoStep.Step415_OutMode_Move_CV_Slow;
                                        }
                                    }
                                }
                                // 이전 컨베이어가 없는 경우 (시작 컨베이어)
                                else
                                {
                                    CV_AutoStep = AutoStep.Step420_OutMode_Run_Condition_Check;
                                }
                            }
                            break;

                        case AutoStep.Step415_OutMode_Move_CV_Slow:
                            {
                                if(beforeconv != null && nextconv != null)
                                {
                                    // Load위치와 Unload위치가 다를 때
                                    if(LoadPos != UnloadPos)
                                    {
                                        // 이전 컨베이어의 타입에 따라 분류
                                        if(nextconv.type == "Long")
                                        {
                                            nextconv.LCnV_CST_Empty_Detect();
                                            // 이전 컨베이어에서 Foup이 감지 되지 않는 경우 저속
                                            if (!nextconv.LCnvCSTDetected)
                                            {
                                                if (LoadLocation != UnloadLocation && ((UnloadLocation - LoadLocation) % 2 == 0))
                                                {
                                                    portDirection = LineDirection.Input;
                                                }
                                                StartConveyor(SlowVelocity);
                                                portDirection = LineDirection.Output;
                                            }
                                        }
                                        else
                                        {
                                            nextconv.CST_Empty_Detect();
                                            // 이전 컨베이어에서 Foup이 감지 되지 않는 경우 저속
                                            if (!nextconv.SCnvCSTDetected)
                                            {
                                                if (LoadLocation != UnloadLocation && ((UnloadLocation - LoadLocation) % 2 == 0))
                                                {
                                                    portDirection = LineDirection.Input;
                                                }
                                                StartConveyor(SlowVelocity);
                                                portDirection = LineDirection.Output;
                                            }
                                        }
                                    }
                                    // Load 위치와 Unload 위치가 같은 경우
                                    else if(LoadPos == UnloadPos)
                                    {
                                        // 이전 컨베이어의 타입에 따라 분류
                                        if(nextconv.type == "Long")
                                        {
                                            nextconv.LCnV_CST_Empty_Detect();
                                            // 이전 컨베이어에서 Foup이 감지 되지 않는 경우
                                            if (!nextconv.LCnvCSTDetected)
                                            {
                                                // 다음 컨베이어의 타입에 따라 분류
                                                if(beforeconv.type == "Long")
                                                {
                                                    beforeconv.LCnV_CST_Empty_Detect();
                                                    // 다음 컨베이어에 Foup이 있다면 저속
                                                    if (beforeconv.LCnvCSTDetected)
                                                    {
                                                        StartConveyor(SlowVelocity);
                                                    }
                                                }
                                                else
                                                {
                                                    beforeconv.CST_Check_Detect();
                                                    // 다음 컨베이어에 Foup이 있다면 저속
                                                    if (beforeconv.SCnvCSTDetected)
                                                    {
                                                        StartConveyor(SlowVelocity);
                                                    }
                                                }
                                            }
                                        }
                                        else
                                        {
                                            nextconv.CST_Empty_Detect();
                                            // 이전 컨베이어에서 Foup이 감지 되지 않는 경우
                                            if (!nextconv.SCnvCSTDetected)
                                            {
                                                // 다음 컨베이어의 타입에 따라 분류
                                                if(beforeconv.type == "Long")
                                                {
                                                    beforeconv.LCnV_CST_Empty_Detect();
                                                    // 다음 컨베이어에 Foup이 있다면 저속
                                                    if (beforeconv.LCnvCSTDetected)
                                                    {
                                                        StartConveyor(SlowVelocity);
                                                    }
                                                }
                                                else
                                                {
                                                    beforeconv.CST_Empty_Detect();
                                                    // 다음 컨베이어에 Foup이 있다면 저속
                                                    if (beforeconv.SCnvCSTDetected)
                                                    {
                                                        StartConveyor(SlowVelocity);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    CV_AutoStep = AutoStep.Step420_OutMode_Run_Condition_Check;
                                }
                                // 다음 컨베이어가 없는 경우 (마지막 컨베이어)
                                else if(beforeconv == null)
                                {
                                    if (LoadLocation != UnloadLocation && ((UnloadLocation - LoadLocation) % 2 == 0))
                                    {
                                        portDirection = LineDirection.Input;
                                    }
                                    StartConveyor(AutoVelocity);
                                    portDirection = LineDirection.Output;
                                    CV_AutoStep = AutoStep.Step420_OutMode_Run_Condition_Check;
                                }
                                // 이전 컨베이어가 없는 경우 (시작 컨베이어)
                                else if(nextconv == null)
                                {
                                    if (LoadLocation != UnloadLocation && ((UnloadLocation - LoadLocation) % 2 == 0))
                                    {
                                        portDirection = LineDirection.Input;
                                    }
                                    StartConveyor(AutoVelocity);
                                    portDirection = LineDirection.Output;
                                    CV_AutoStep = AutoStep.Step420_OutMode_Run_Condition_Check;
                                }
                            }
                            break;

                        case AutoStep.Step420_OutMode_Run_Condition_Check:
                            {
                                CST_Check_Detect();
                                // Load위치와 Unload위치가 같고 Foup이 정위치에 있을 때
                                if((LoadLocation == UnloadLocation) && SCnVCSTBoth)
                                {
                                    if(beforeconv != null)
                                    {
                                        // 다음 컨베이어의 타입에 따라 분류
                                        if(beforeconv.type == "Normal")
                                        {
                                            beforeconv.CST_Empty_Detect();
                                            // 다음 컨베이어가 비어 있는 경우
                                            if (!beforeconv.SCnvCSTDetected)
                                            {
                                                CV_AutoStep = AutoStep.Step460_OutMode_Unload_Turn_Stop;
                                            }
                                            // 다음 컨베이어에 Foup이 적재되어 있는 경우
                                            else
                                            {
                                                StopConveyor();
                                                CV_AutoStep = AutoStep.Step450_OutMode_Move_CV_Rolling_Out;
                                            }
                                        }
                                        // 다음 컨베이어가 Long 컨베이어인 경우
                                        else if(beforeconv.type == "Long")
                                        {
                                            beforeconv.LCnV_CST_Empty_Detect();
                                            // 다음 컨베이어가 비어 있는 경우
                                            if (!beforeconv.LCnvCSTDetected)
                                            {
                                                CV_AutoStep = AutoStep.Step460_OutMode_Unload_Turn_Stop;
                                            }
                                            // 다음 컨베이어에 Foup이 적재되어 있는 경우 정지
                                            else
                                            {
                                                StopConveyor();
                                                CV_AutoStep = AutoStep.Step450_OutMode_Move_CV_Rolling_Out;
                                            }
                                        }
                                    }
                                    // 마지막 컨베이어인 경우 정지
                                    else
                                    {
                                        StopConveyor();
                                        CV_AutoStep = AutoStep.Step900_Final_CV_Wait;
                                    }
                                }
                                // Load 위치와 Unload 위치가 다른 경우 정지
                                else if (SCnVCSTBoth)
                                {
                                    StopConveyor();

                                    CV_AutoStep = AutoStep.Step830_OutMode_Load_Move;
                                }
                            }
                            break;

                        case AutoStep.Step450_OutMode_Move_CV_Rolling_Out:
                            {
                                // 다음 컨베이어의 타입에 따라 분류
                                if(beforeconv.type == "Normal")
                                {
                                    beforeconv.CST_Empty_Detect();
                                    // 다음 컨베이어가 비어 있는 경우
                                    if (!beforeconv.SCnvCSTDetected)
                                    {
                                        // Load 상태
                                        turnstatus = TurnStatus.Unload;
                                        // Load위치와 Unload위치가 다르고 POS Sensordml 차이가 2가 날 때
                                        // Ex) Load : Pos[0] / Unload : Pos[2]
                                        if(LoadLocation != UnloadLocation && ((UnloadLocation - LoadLocation) % 2 == 0))
                                        {
                                            Thread.Sleep(500);
                                            // 방향을 Pos로 변경 후 이동
                                            portDirection = LineDirection.Output;
                                            StartConveyor(AutoVelocity);
                                        }
                                        else
                                        {
                                            Thread.Sleep(500);
                                            StartConveyor(AutoVelocity);
                                        }
                                        CV_AutoStep = AutoStep.Step460_OutMode_Unload_Turn_Stop;
                                    }
                                }
                                else if(beforeconv.type == "Long")
                                {
                                    beforeconv.LCnV_CST_Empty_Detect();
                                    // 다음 컨베이어가 비어 있는 경우
                                    if (!beforeconv.LCnvCSTDetected)
                                    {
                                        // Unload 상태
                                        turnstatus= TurnStatus.Unload;
                                        // Load위치와 Unload위치가 다르고 POS Sensordml 차이가 2가 날 때
                                        // Ex) Load : Pos[0] / Unload : Pos[2]
                                        if (LoadLocation != UnloadLocation && ((UnloadLocation - LoadLocation) % 2 == 0))
                                        {
                                            Thread.Sleep(500);
                                            // 방향을 Pos로 변경 후 이동
                                            portDirection = LineDirection.Output;
                                            StartConveyor(AutoVelocity);
                                        }
                                        else
                                        {
                                            Thread.Sleep(500);
                                            StartConveyor(AutoVelocity);
                                        }
                                        CV_AutoStep = AutoStep.Step460_OutMode_Unload_Turn_Stop;
                                    }
                                }
                            }
                            break;

                        case AutoStep.Step460_OutMode_Unload_Turn_Stop:
                            {
                                turnstatus = TurnStatus.Unload;
                                CST_Empty_Detect();
                                // Foup이 다 빠져 나간 경우
                                if (!SCnvCSTDetected)
                                {
                                    // 0.3초 후 정지
                                    Thread.Sleep(300);
                                    StopConveyor();
                                    // Load 위치와 Unload 위치가 같은 경우 초기화
                                    if (LoadLocation == UnloadLocation)
                                    {
                                        CV_AutoStep = AutoStep.Step000_Check_Direction;
                                    }
                                    // Load 위치와 Unload 위치가 다른 경우
                                    else
                                    {
                                        // 다음 컨베이어의 타입에 따라 분류
                                        if(beforeconv.type == "Long")
                                        {
                                            beforeconv.LCnV_CST_Empty_Detect();
                                            // 다음 컨베이어에 Foup이 감지된 경우
                                            if (beforeconv.LCnvCSTDetected)
                                            {
                                                CV_AutoStep = AutoStep.Step850_OutMode_Return_T_Move;
                                            }
                                        }
                                        else
                                        {
                                            beforeconv.CST_Empty_Detect();
                                            // 다음 컨베이어에 Foup이 감지된 경우
                                            if (beforeconv.SCnvCSTDetected)
                                            {
                                                CV_AutoStep = AutoStep.Step850_OutMode_Return_T_Move;
                                            }
                                        }
                                    }
                                }
                            }
                            break;

                        case AutoStep.Step475_OutMode_Change_410:
                            {
                                CST_Empty_Detect();
                                // Foup이 감지된 경우
                                if (SCnvCSTDetected)
                                {
                                    CV_AutoStep = AutoStep.Step410_OutMode_Move_CV_Rolling_out;
                                }
                            }
                            break;

                        /// <summary>
                        /// 1. 이전 Conveyor에 Foup이 적재되면 구동
                        /// </summary>
                        case AutoStep.Step500_InMode_Get_CST_Rolling:
                            {
                                // 이전 컨베이어의 Auto Step Check 후 동작
                                if (beforeconv.CV_AutoStep == AutoStep.Step250_InMode_Move_CV_Rolling_Out)
                                {
                                    // Busy 상태
                                    turnstatus = TurnStatus.Busy;
                                    StartConveyor(AutoVelocity);
                                    CV_AutoStep = AutoStep.Step275_InMode_Change_210;
                                }
                            }
                            break;

                        case AutoStep.Step600_OutMode_Get_CST_Rolling:
                            {
                                if(nextconv.CV_AutoStep == AutoStep.Step450_OutMode_Move_CV_Rolling_Out)
                                {
                                    turnstatus = TurnStatus.Busy;
                                    if(LoadLocation != UnloadLocation && ((UnloadLocation - LoadLocation) % 2 == 0))
                                    {
                                        portDirection = LineDirection.Input;
                                    }
                                    StartConveyor(AutoVelocity);
                                    portDirection = LineDirection.Output;
                                    CV_AutoStep = AutoStep.Step475_OutMode_Change_410;
                                }
                            }
                            break;

                        case AutoStep.Step710_InMode_Move_T_0_Deg:
                            {
                                // Load 위치로 이동
                                Absolute_Turn_Move_Load();
                                turnstatus = TurnStatus.Busy;
                                CV_AutoStep = AutoStep.Step720_InMode_Move_T_Stop;
                            }
                            break;

                        case AutoStep.Step720_InMode_Move_T_Stop:
                            {
                                Load_POS_Check();
                                CoreMotionAxisStatus cmAxis = WMX3.m_coreMotionStatus.AxesStatus[TurnAxis];
                                // Load 위치와 Current POS값이 같고  Load POS Sensor가 On인 경우
                                if (TcvLoadDetect && cmAxis.ActualPos == LoadPos)
                                {
                                    CV_AutoStep = AutoStep.Step000_Check_Direction;
                                }
                            }
                            break;

                        /// <summary>
                        /// 1. Turn Coveyor Unload위치로 구동
                        /// </summary>
                        case AutoStep.Step730_InMode_Unload_Move:
                            {
                                // Load 위치와 Unload 위치가 같은 경우
                                if (LoadLocation == UnloadLocation)
                                {
                                    // 다음 컨베이어가 있는 경우
                                    if (nextconv != null)
                                    {
                                        CV_AutoStep = AutoStep.Step250_InMode_Move_CV_Rolling_Out;
                                    }
                                    // 다음 컨베이어가 없는 경우 (마지막 컨베이어)
                                    else
                                    {
                                        CV_AutoStep = AutoStep.Step900_Final_CV_Wait;
                                    }
                                }
                                // Load 위치와 Unload 위치가 다른 경우
                                else
                                {
                                    // 0.3초 후 Unload위치로 이동
                                    Thread.Sleep(300);
                                    Absolute_Turn_Move_Unload();
                                    CV_AutoStep = AutoStep.Step740_InMode_Unload_Stop;
                                }
                            }
                            break;

                        /// <summary>
                        /// 1. Unload위치에 도착 시 정지
                        /// </summary>
                        case AutoStep.Step740_InMode_Unload_Stop:
                            {
                                Unload_POS_Check();
                                CoreMotionAxisStatus cmAxis = WMX3.m_coreMotionStatus.AxesStatus[TurnAxis];
                                // Unload Pos값과 Current Pos값이 같고 Unload POS Sensor가 On인 경우
                                if (TcvUnloadDetect && cmAxis.ActualPos == UnloadPos)
                                {
                                    // 다음 컨베이어가 있는 경우
                                    if (nextconv != null)
                                    {
                                        CV_AutoStep = AutoStep.Step250_InMode_Move_CV_Rolling_Out;
                                    }
                                    // 다음 컨베이어가 없는 경우 (마지막 컨베이어)
                                    else
                                    {
                                        CV_AutoStep = AutoStep.Step900_Final_CV_Wait;
                                    }
                                }
                            }
                            break;

                        /// <summary>
                        /// 1.Load위치로 Turn Conveyor 복귀
                        /// </summary>
                        case AutoStep.Step750_InMode_Return_T_Move:
                            {
                                // Busy 상태
                                turnstatus = TurnStatus.Busy;
                                // 0.5초 후 Load 위치로 이동
                                Thread.Sleep(300);
                                Absolute_Turn_Move_Load();
                                CV_AutoStep = AutoStep.Step760_InMode_LoadReady_T;
                            }
                            break;

                        /// <summary>
                        /// 1.Load위치에 위치 시 Turn Conveyor 정지 후 Step 초기화
                        /// </summary>
                        case AutoStep.Step760_InMode_LoadReady_T:
                            {
                                Load_POS_Check();
                                CoreMotionAxisStatus cmAxis = WMX3.m_coreMotionStatus.AxesStatus[TurnAxis];
                                // Load Pos 값과 Current POS값이 같고 Load POS Sensor가 On인 경우
                                if (TcvLoadDetect && cmAxis.ActualPos == LoadPos)
                                {
                                    CV_AutoStep = AutoStep.Step000_Check_Direction;
                                }
                            }
                            break;

                        case AutoStep.Step810_OutMode_Move_T_Unload:
                            {
                                // Unload 위치로 이동
                                Absolute_Turn_Move_Unload();
                                turnstatus = TurnStatus.Busy;
                                CV_AutoStep = AutoStep.Step820_OutMode_Move_T_Stop;
                            }
                            break;

                        case AutoStep.Step820_OutMode_Move_T_Stop:
                            {
                                Unload_POS_Check();
                                CoreMotionAxisStatus cmAxis = WMX3.m_coreMotionStatus.AxesStatus[TurnAxis];
                                // Unload 위치와 Current POS값이 같고 Load POS Sensor가 On인 경우
                                if(TcvUnloadDetect && cmAxis.ActualPos == UnloadPos)
                                {
                                    CV_AutoStep = AutoStep.Step000_Check_Direction;
                                }
                            }
                            break;

                        case AutoStep.Step830_OutMode_Load_Move:
                            {
                                // Load 위치와 Unload 위치가 같은 경우
                                if(LoadLocation == UnloadLocation)
                                {
                                    // 다음 컨베이어가 있는 경우
                                    if(beforeconv != null)
                                    {
                                        CV_AutoStep = AutoStep.Step450_OutMode_Move_CV_Rolling_Out;
                                    }
                                    // 다음 컨베이어가 없는 경우 (마지막 컨베이어)
                                    else
                                    {
                                        CV_AutoStep = AutoStep.Step900_Final_CV_Wait;
                                    }
                                }
                                // Load 위치와 Unload 위치가 다른 경우
                                else
                                {
                                    // 0.3초 후 Load위치로 이동
                                    Thread.Sleep(300);
                                    Absolute_Turn_Move_Load();
                                    CV_AutoStep = AutoStep.Step840_OutMode_Load_Stop;
                                }
                            }
                            break;
                        
                        case AutoStep.Step840_OutMode_Load_Stop:
                            {
                                Load_POS_Check();
                                CoreMotionAxisStatus cmAxis = WMX3.m_coreMotionStatus.AxesStatus[TurnAxis];
                                // Load Pos값과 Current Pos값이 같고 Load POS Sensor가 On인 경우
                                if(TcvLoadDetect && cmAxis.ActualPos == LoadPos)
                                {
                                    // 다음 컨베이어가 있는 경우
                                    if(beforeconv != null)
                                    {
                                        CV_AutoStep = AutoStep.Step450_OutMode_Move_CV_Rolling_Out;
                                    }
                                    // 다음 컨베이어가 없는 경우 (마지막 컨베이어)
                                    else
                                    {
                                        CV_AutoStep = AutoStep.Step900_Final_CV_Wait;
                                    }
                                }
                            }
                            break;

                        case AutoStep.Step850_OutMode_Return_T_Move:
                            {
                                // Busy 상태
                                turnstatus = TurnStatus.Busy;
                                // 0.5초 후 Unload 위치로 이동
                                Thread.Sleep(300);
                                Absolute_Turn_Move_Unload();
                                CV_AutoStep = AutoStep.Step860_OutMode_UnloadReady_T;
                            }
                            break;

                        case AutoStep.Step860_OutMode_UnloadReady_T:
                            {
                                Unload_POS_Check();
                                CoreMotionAxisStatus cmAxis = WMX3.m_coreMotionStatus.AxesStatus[TurnAxis];
                                // Unload Pos 값과 Current POS값이 같고 Unload POS Sensor가 On인 경우
                                if(TcvUnloadDetect && cmAxis.ActualPos == UnloadPos)
                                {
                                    CV_AutoStep = AutoStep.Step000_Check_Direction;
                                }
                            }
                            break;

                        case AutoStep.Step900_Final_CV_Wait:
                            {
                                if (IsCycleRun)
                                {
                                    if (lines[0].IdleCheck())
                                    {
                                        if (CurrentCycle >= TargetCycle || CycleStop)
                                        {
                                            CurrentCycle = 0;
                                            TargetCycle = 0;
                                            IsCycleRun = false;
                                            lines[0].EndTime = DateTime.Now;
                                        }
                                        else
                                        {
                                            CurrentCycle++;
                                            Console.WriteLine(CurrentCycle);
                                            lines[0].ChangeMode(portDirection);
                                            Thread.Sleep(300);
                                            lines[0].ChangeStep();
                                        }
                                    }
                                }
                                // Foup이 없어진 경우 Auto Step 초기화
                                else
                                {
                                    CST_Empty_Detect();
                                    if (!SCnvCSTDetected)
                                    {
                                        CV_AutoStep = AutoStep.Step000_Check_Direction;
                                    }
                                }
                            }
                            break;

                        default:
                            break;
                    }
                    if (prestep != CV_AutoStep)
                    {
                        Console.WriteLine(ID + ":" + CV_AutoStep);
                        prestep = CV_AutoStep;
                    }
                    Thread.Sleep(10); // CPU 사용량 감소를 위한 대기
                }
                Console.WriteLine(ID + ":" + "Auto Stop");
                StopConveyor();
                TurnJogSTOP();
                mode = Mode.Manual;
                NCV_AutoRunning = false;
                NCV_CycleRunning = false;
                G_Var.IsAutoRun = false;
                G_Var.IsCycleRun = false;
            });
            LocalThread.Start();
        }
        public TurnConv(int id, int axis, bool Isinterface) : base(id, axis, Isinterface)
        {
            type = "Turn";
            TurnAxis = Axis + 1;
            bits.Add(2);
            bits.Add(3);
            bitsTurn.Add(6);
            bitsTurn.Add(2);
            bitsTurn.Add(3);
            bitTurn = 6;
        }
        public override void AddrUpdate()
        {
            addr = 8 + Axis * 4;
            addrTurn = addr + 4;
        }
    }
}
